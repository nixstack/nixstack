name: Push And Release to Heroku

on:
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # auto-generated
      # cannot use HEROKU_API_KEY, otherwise log in failedError: Cannot log in with HEROKU_API_KEY set
      HEROKU_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
      HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v2

      # - name: Install Node ${{ matrix.node }}
      #   uses: actions/setup-node@v1
      #   with:
      #     node-version: ${{ matrix.node }}
      # - name: Install dependencies
      #   run: npx lerna bootstrap
      # create .netrc file for heroku authentication
      # https://devcenter.heroku.com/articles/authentication
      - name: Create .netrc for Heroku login
        run: |+
          cat >~/.netrc <<EOF
          machine api.heroku.com
              login $HEROKU_EMAIL
              password $HEROKU_KEY
          machine git.heroku.com
              login $HEROKU_EMAIL
              password $HEROKU_KEY
          EOF

        # login with .netrc file
      - run: heroku login
      - run: heroku git:remote -a $HEROKU_APP_NAME
      - run: "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow
      - run: git push heroku HEAD:refs/heads/master -f
      - run: heroku ps:exec 'npx lerna bootstrap'
